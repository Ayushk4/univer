<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Univer Sheets AI Agent</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family:
                    -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
                height: 100vh;
                display: flex;
                overflow: hidden;
            }

            #left-panel {
                flex: 1;
                border-right: 2px solid #e0e0e0;
                display: flex;
                flex-direction: column;
            }

            #univerFrame {
                width: 100%;
                height: 100%;
                border: none;
            }

            #right-panel {
                flex: 1;
                display: flex;
                flex-direction: column;
                background-color: #f5f5f5;
            }

            #header {
                padding: 20px;
                background-color: #fff;
                border-bottom: 1px solid #e0e0e0;
            }

            #header h1 {
                font-size: 24px;
                color: #333;
                margin-bottom: 8px;
            }

            #header p {
                font-size: 14px;
                color: #666;
            }

            #input-area {
                padding: 20px;
                background-color: #fff;
                border-bottom: 1px solid #e0e0e0;
            }

            #prompt {
                width: 100%;
                padding: 12px;
                border: 1px solid #ddd;
                border-radius: 4px;
                font-size: 14px;
                font-family: inherit;
                resize: vertical;
                min-height: 80px;
            }

            #prompt:disabled {
                background-color: #f0f0f0;
                cursor: not-allowed;
            }

            #submit-btn {
                margin-top: 10px;
                padding: 10px 20px;
                background-color: #007bff;
                color: white;
                border: none;
                border-radius: 4px;
                font-size: 14px;
                cursor: pointer;
                transition: background-color 0.2s;
            }

            #submit-btn:hover:not(:disabled) {
                background-color: #0056b3;
            }

            #submit-btn:disabled {
                background-color: #ccc;
                cursor: not-allowed;
            }

            #output-area {
                flex: 1;
                padding: 20px;
                overflow-y: auto;
            }

            .result-box {
                background-color: #fff;
                border-radius: 6px;
                padding: 20px;
                margin-bottom: 15px;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            }

            .result-box h3 {
                margin-bottom: 10px;
                color: #333;
                font-size: 16px;
            }

            .result-box pre {
                background-color: #f5f5f5;
                padding: 12px;
                border-radius: 4px;
                overflow-x: auto;
                white-space: pre-wrap;
                font-size: 13px;
                line-height: 1.5;
            }

            .answer-box {
                background-color: #e8f5e9;
                border-left: 4px solid #4caf50;
            }

            .loading {
                text-align: center;
                padding: 20px;
                color: #666;
            }

            .error {
                background-color: #ffebee;
                border-left: 4px solid #f44336;
                padding: 15px;
                border-radius: 4px;
                color: #c62828;
            }
        </style>
    </head>
    <body>
        <div id="left-panel">
            <iframe src="http://localhost:3002/sheets/" id="univerFrame"></iframe>
        </div>

        <div id="right-panel">
            <div id="header">
                <h1>AI Assistant</h1>
                <p>Ask a question about the spreadsheet (single query only)</p>
            </div>

            <div id="input-area">
                <textarea
                    id="prompt"
                    placeholder="Enter your question here... (e.g., 'What sheets are available?' or 'Get data from A1:C5')"
                ></textarea>
                <button id="submit-btn">Send Query</button>
            </div>

            <div id="output-area" id="output">
                <p style="color: #999; text-align: center; margin-top: 40px">Enter a question to get started</p>
            </div>
        </div>

        <script>
            const promptInput = document.getElementById('prompt');
            const submitBtn = document.getElementById('submit-btn');
            const outputArea = document.getElementById('output-area');

            let submitted = false;
            let startTime = null;
            let timerInterval = null;

            submitBtn.addEventListener('click', async () => {
                if (submitted) return;

                const prompt = promptInput.value.trim();
                if (!prompt) {
                    alert('Please enter a question');
                    return;
                }

                // Disable input after submission
                submitted = true;
                promptInput.disabled = true;
                submitBtn.disabled = true;

                // Start timer
                startTime = Date.now();

                // Show initial state with timer
                outputArea.innerHTML = `
                <div class="loading">
                    ü§ñ Processing your query...<br>
                    <div id="timer" style="margin-top: 10px; font-family: monospace;">Elapsed: 0.0s</div>
                </div>
                <div id="steps-container"></div>
            `;

                // Update timer every 100ms
                timerInterval = setInterval(() => {
                    const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
                    const timerEl = document.getElementById('timer');
                    if (timerEl) timerEl.textContent = `Elapsed: ${elapsed}s`;
                }, 100);

                try {
                    // Use EventSource for SSE
                    const eventSource = new EventSource(
                        '/query?' +
                            new URLSearchParams({
                                prompt: prompt,
                            }),
                    );

                    let hasReceivedData = false;
                    let isDone = false;

                    eventSource.onmessage = (event) => {
                        hasReceivedData = true;
                        const data = JSON.parse(event.data);
                        if (data.type === 'done') {
                            isDone = true;
                            eventSource.close();
                        }
                        handleSSEMessage(data);
                    };

                    eventSource.onerror = (error) => {
                        eventSource.close();
                        clearInterval(timerInterval);
                        // Only show error if we haven't completed successfully
                        if (!isDone && !document.querySelector('.answer-box')) {
                            outputArea.innerHTML = `
                            <div class="error">
                                <strong>Error:</strong> ${hasReceivedData ? 'Connection interrupted' : 'Failed to connect to server'}
                            </div>
                        `;
                        }
                    };
                } catch (error) {
                    clearInterval(timerInterval);
                    outputArea.innerHTML = `
                    <div class="error">
                        <strong>Error:</strong> ${error.message}
                    </div>
                `;
                }
            });

            // Allow Enter+Shift for newline, Enter alone to submit
            promptInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey && !submitted) {
                    e.preventDefault();
                    submitBtn.click();
                }
            });

            function handleSSEMessage(data) {
                const stepsContainer = document.getElementById('steps-container');
                const now = new Date();
                const timestamp = now.toLocaleTimeString() + '.' + String(now.getMilliseconds()).padStart(3, '0');

                if (data.type === 'step') {
                    // Add step to container
                    const stepDiv = document.createElement('div');
                    stepDiv.className = 'result-box';
                    stepDiv.innerHTML = `
                    <div style="color: #666; font-size: 12px; margin-bottom: 5px;">‚è±Ô∏è ${timestamp}</div>
                    <pre>${escapeHtml(data.data)}</pre>
                `;
                    stepsContainer.appendChild(stepDiv);
                    stepDiv.scrollIntoView({ behavior: 'smooth', block: 'end' });
                } else if (data.type === 'final') {
                    // Add final answer
                    const finalDiv = document.createElement('div');
                    finalDiv.className = 'result-box answer-box';
                    finalDiv.innerHTML = `
                    <h3>‚úÖ Answer</h3>
                    <div style="color: #666; font-size: 12px; margin-bottom: 5px;">‚è±Ô∏è ${timestamp}</div>
                    <pre>${escapeHtml(data.answer)}</pre>
                `;
                    stepsContainer.appendChild(finalDiv);

                    if (data.usage) {
                        const usageDiv = document.createElement('div');
                        usageDiv.className = 'result-box';
                        usageDiv.innerHTML = `
                        <h3>üìä Usage</h3>
                        <pre>${escapeHtml(data.usage)}</pre>
                    `;
                        stepsContainer.appendChild(usageDiv);
                    }

                    finalDiv.scrollIntoView({ behavior: 'smooth', block: 'end' });
                } else if (data.type === 'done') {
                    // Remove loading indicator and stop timer
                    const loading = document.querySelector('.loading');
                    if (loading) loading.remove();
                    clearInterval(timerInterval);

                    // Add completion message
                    const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
                    const doneDiv = document.createElement('div');
                    doneDiv.style.cssText = 'text-align: center; padding: 15px; color: #4caf50; font-weight: bold;';
                    doneDiv.textContent = `‚úì Completed in ${elapsed}s`;
                    stepsContainer.appendChild(doneDiv);
                } else if (data.type === 'error') {
                    clearInterval(timerInterval);
                    outputArea.innerHTML = `
                    <div class="error">
                        <strong>Error:</strong> ${escapeHtml(data.message)}
                    </div>
                `;
                }
            }

            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        </script>
    </body>
</html>
